ext {
    println("Environment        : JAVA_HOME=$System.env.JAVA_HOME")
    println("Gradle Version     : ${gradleVersion}")
    println("Target JDK Version : ${javaVersion}")
    println("Kotlin Version     : ${kotlinVersion}")
    println("Spring Boot Version: ${springBootVersion}")
    println("Core Version       : ${CoreVersion}")
    println("Encoding           : ${encoding}")
    println("Build Version      : ${version}")
}

buildscript {
    dependencies {
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:${kotlinVersion}"
        classpath "org.jetbrains.kotlin:kotlin-allopen:${kotlinVersion}"
        classpath "org.jetbrains.kotlin:kotlin-noarg:${kotlinVersion}"
        classpath "org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}"
    }
    repositories {
        mavenLocal()
        maven {
            url = "${mavenCentralUrl}"
            allowInsecureProtocol = true
        }
        mavenCentral()
        jcenter()
    }
}

allprojects {

    apply plugin: 'java'
    apply plugin: 'kotlin'
    apply plugin: 'kotlin-kapt'
    apply plugin: 'kotlin-spring'
    apply plugin: 'kotlin-noarg'
    apply plugin: 'kotlin-jpa'
    apply plugin: 'idea'
    apply plugin: 'maven-publish'

    apply from: "$rootDir/gradle/dependencies.gradle"
    apply from: "$rootDir/gradle/environment.gradle"

    sourceCompatibility = "${javaVersion}"
    targetCompatibility = "${javaVersion}"

    buildscript {
        repositories {
            mavenLocal()
            maven {
                url = "${mavenCentralUrl}"
                allowInsecureProtocol = true
            }
            mavenCentral()
            jcenter()
        }
    }

    repositories {
        mavenLocal()
        maven {
            url = "${mavenCentralUrl}"
            allowInsecureProtocol = true
        }
        mavenCentral()
        jcenter()
    }

    dependencies {
        testImplementation("org.junit.jupiter:junit-jupiter:$versions.jupiter")
        testImplementation("org.junit.platform:junit-platform-launcher:$versions.junit_platform")
        testImplementation "org.jetbrains.kotlin:kotlin-test"
        testImplementation "org.jetbrains.kotlin:kotlin-test-junit5"
        implementation "org.jetbrains.kotlin:kotlin-stdlib"
        implementation "org.jetbrains.kotlin:kotlin-reflect"
        implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$versions.kotlin_coroutines"
    }

    task clearPj(type: Delete) {
        delete 'release', 'build', 'target', 'out'
    }

    task copyJar(type: Copy) {
        from(configurations.runtimeClasspath)
        into('build/libs/dependencies')
    }

    task mapperFileCopy(type: Copy) {
        copy {
            from("src/main/java") {
                include("**/*.xml")
                include("**/*.json")
                include("**/*.properties")
            }
            into("${buildDir}/classes/main")
        }
        copy {
            from("src/test/java") {
                include("**/*.xml")
                include("**/*.json")
                include("**/*.properties")
            }
            into("${buildDir}/classes/test")
        }
        copy {
            from("src/main/kotlin") {
                include("**/*.xml")
                include("**/*.json")
                include("**/*.properties")
            }
            into("${buildDir}/classes/main")
        }
        copy {
            from("src/test/kotlin") {
                include("**/*.xml")
                include("**/*.json")
                include("**/*.properties")
            }
            into("${buildDir}/classes/test")
        }
    }

    jar {
        dependsOn(copyJar)
        manifest {
            attributes('Version': "${project.version}", 'Provider': "Gradle ${gradleVersion}", 'JDK': "${javaVersion}", 'Kotlin': "${kotlinVersion}", 'Project': 'Acp Admin Cloud')
        }
    }

    java {
        withJavadocJar()
        withSourcesJar()
    }

    javadoc {
        options.charSet = "${encoding}"
        options.docEncoding = "${encoding}"
        options.encoding = "${encoding}"
        options.addStringOption('Xdoclint:none', '-quiet')
    }

    compileJava {
        options.encoding = "${encoding}"
    }
    compileJava.dependsOn(processResources)
    compileTestJava {
        options.encoding = "${encoding}"
    }

    compileKotlin {
        kotlinOptions {
            jvmTarget = "${javaVersion}"
        }
    }
    compileKotlin.dependsOn(processResources)
    compileTestKotlin {
        kotlinOptions {
            jvmTarget = "${javaVersion}"
        }
    }

    test {
        useJUnitPlatform()
    }

    def generateShell = { String appJarName ->
        File templateFile = new File("$rootDir/doc/script/server.model")
        List<String> lines = templateFile.readLines("UTF-8")
        StringBuffer buffer = new StringBuffer()
        for (String line : lines) {
            buffer.append(line).append("\n")
        }
        String shellContent = buffer.toString()
        shellContent = shellContent.replaceAll("@appJarName@", appJarName)
        File outFile = new File("$rootDir/release/$project.name/server.sh")
        Writer writer = new FileWriter(outFile)
        writer.write(new String(shellContent.getBytes("UTF-8")))
        writer.flush()
        writer.close()
    }

    build {
        doLast {
            def needCopy = {
                return ["admin-server",
                        "deploy-server",
                        "gateway-server",
                        "log-server",
                        "oauth-server",
                        "workflow-server",
                        "route-server"].toArray().contains("$project.name")
            }
            if (needCopy()) {
                def fileName = "$project.name" + "-" + "$project.version" + ".jar"
                copy {
                    from file("${buildDir}/libs/" + fileName)
                    into "$rootDir/release/$project.name"
                }
                copy {
                    from "${buildDir}/resources/main"
                    into "$rootDir/release/$project.name"
                }
                generateShell(fileName)
            }
        }
    }

    task release(dependsOn: [build, copyJar]) {
        doLast {
            if (project.hasProperty("active") && project.active != null && project.active != "") {
                println("$project.name release finished: active=$project.active")
                File bootStrapFile = new File("$rootDir/release/$project.name/bootstrap.yaml")
                if (bootStrapFile.exists()) {
                    def text = bootStrapFile.text
                            .replaceAll(" {4}active: (?!\\\$).*", "    active: $project.active")
                            .replaceAll(" {6}server-addr: (?!\\\$).*", "      server-addr: " + nacos_server_addr["$project.active"])
                    bootStrapFile.withPrintWriter { printWriter ->
                        printWriter.println(text)
                    }
                }
            }
        }
    }
}